---
# tasks file for KubevirtTemplateValidator
- name: Set template:view role
  k8s:
    state: present
    definition: "{{ lookup('template', 'template-view-role.yaml.j2') | from_yaml }}"
- name: Create the service
  k8s:
    state: present
    definition: "{{ item | from_yaml }}"
  with_items: "{{ lookup('template', 'service.yaml.j2').split('\n---\n') | select('search', '(^|\n)[^#]') | list }}"
# per https://docs.okd.io/latest/dev_guide/secrets.html#service-serving-certificate-secrets
# *every* pod in the cluster has access to the service-ca.crt, so we can safely use
# the one inside the operator POD
  register: tv
- name: Extract the CA bundle
  set_fact:
    cabundle: "{{ lookup('file', '/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt') | b64encode }}"
- name: Register the webhook
  k8s:
    state: present
    definition: "{{ lookup('template', 'webhook.yaml.j2') | from_yaml }}"
- name: Wait for the template-validator to start
  set_fact:
    tv_status: "{{ lookup('k8s', kind=tv.result.kind, namespace=tv.result.metadata.namespace, resource_name=tv.result.metadata.name) | from_yaml }}"
  retries: 300
  delay: 10
  until: tv_status.status.currentNumberScheduled == tv_status.status.numberReady |default(false)
  when: not wait
